<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myproject.caseNara.mapper.BillMapper">

    <!-- Bill 생성 -->
    <insert id="insertBill" parameterType="com.myproject.caseNara.model.Bill" useGeneratedKeys="true" keyProperty="billId">
        <selectKey keyProperty="billId" resultType="long" order="BEFORE">
            SELECT COALESCE(MAX(BILL_ID), 0) + 1 FROM BILLS
        </selectKey>
        INSERT INTO BILLS (
            BILL_ID,
            CUSTOMER_ID,
            TOTAL_COST,
            REMAIN_COST,
            STATUS,
            CREATED_AT
        ) VALUES (
            #{billId,jdbcType=NUMERIC},
            #{customerId,jdbcType=NUMERIC},
            #{totalCost,jdbcType=NUMERIC},
            #{remainCost,jdbcType=NUMERIC},
            #{status,jdbcType=NUMERIC},
            #{createdAt,jdbcType=TIMESTAMP}
        )
    </insert>

    <!-- 고객별 Bill 목록 조회 -->
    <select id="listBillsByCustomerId" parameterType="long" resultType="com.myproject.caseNara.model.Bill">
        SELECT 
            BILL_ID as billId,
            CUSTOMER_ID as customerId,
            TOTAL_COST as totalCost,
            REMAIN_COST as remainCost,
            STATUS as status,
            CREATED_AT as createdAt
        FROM BILLS
        WHERE CUSTOMER_ID = #{customerId}
        ORDER BY CREATED_AT DESC
    </select>

    <!-- 남은 금액 업데이트 -->
    <update id="updateRemainCost">
        UPDATE BILLS
        SET REMAIN_COST = #{remainCost}
        WHERE BILL_ID = #{billId}
    </update>

    <!-- 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE BILLS
        SET STATUS = #{status}
        WHERE BILL_ID = #{billId}
    </update>

    <!-- bills_sales 매핑 일괄 저장 -->
    <insert id="insertBillSales">
        INSERT INTO BILLS_SALES (BILL_ID, SALES_ID)
        VALUES
        <foreach collection="salesIds" item="sid" separator=",">
            (#{billId}, #{sid})
        </foreach>
    </insert>

    <!-- 상태=0인 Bill과 매핑된 Sales를 조회 -->
    <select id="listBillsWithSales" resultType="com.myproject.caseNara.model.BillWithSales">
        SELECT 
            a.BILL_ID as billId,
            a.CUSTOMER_ID as customerId,
            a.TOTAL_COST as totalCost,
            a.REMAIN_COST as remainCost,
            a.STATUS as status,
            a.CREATED_AT as createdAt,
            b.SALES_ID as salesId
        FROM BILLS a
        JOIN BILLS_SALES b ON a.BILL_ID = b.BILL_ID
        WHERE a.STATUS = 0
        ORDER BY a.BILL_ID
    </select>

</mapper>
