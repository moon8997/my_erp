<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myproject.caseNara.mapper.BillMapper">

    <!-- Bill 생성 -->
    <insert id="insertBill" parameterType="com.myproject.caseNara.model.Bill" useGeneratedKeys="true" keyProperty="billId">
        <selectKey keyProperty="billId" resultType="long" order="BEFORE">
            SELECT COALESCE(MAX(BILL_ID), 0) + 1 FROM BILLS
        </selectKey>
        INSERT INTO BILLS (
            BILL_ID,
            CUSTOMER_ID,
            TOTAL_COST,
            REMAIN_COST,
            STATUS,
            CREATED_AT
        ) VALUES (
            #{billId,jdbcType=NUMERIC},
            #{customerId,jdbcType=NUMERIC},
            #{totalCost,jdbcType=NUMERIC},
            #{remainCost,jdbcType=NUMERIC},
            #{status,jdbcType=NUMERIC},
            #{createdAt,jdbcType=TIMESTAMP}
        )
    </insert>

    <!-- 고객별 Bill 목록 조회 -->
    <select id="listBillsByCustomerId" parameterType="long" resultType="com.myproject.caseNara.model.Bill">
        SELECT 
            BILL_ID as billId,
            CUSTOMER_ID as customerId,
            TOTAL_COST as totalCost,
            REMAIN_COST as remainCost,
            STATUS as status,
            CREATED_AT as createdAt
        FROM BILLS
        WHERE CUSTOMER_ID = #{customerId}
        ORDER BY CREATED_AT DESC
    </select>

    <!-- 남은 금액 업데이트 -->
    <update id="updateRemainCost">
        UPDATE BILLS
        SET REMAIN_COST = #{remainCost}
        WHERE BILL_ID = #{billId}
    </update>

    <!-- 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE BILLS
        SET STATUS = #{status}
        WHERE BILL_ID = #{billId}
    </update>

</mapper>