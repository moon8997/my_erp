<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myproject.caseNara.mapper.BillMapper">

    <!-- Bill 생성 -->
    <insert id="insertBill" parameterType="com.myproject.caseNara.model.Bill" useGeneratedKeys="true" keyProperty="billId">
        <selectKey keyProperty="billId" resultType="long" order="BEFORE">
            SELECT COALESCE(MAX(BILL_ID), 0) + 1 FROM BILLS
        </selectKey>
        INSERT INTO BILLS (
            BILL_ID,
            CUSTOMER_ID,
            TOTAL_COST,
            REMAIN_COST,
            STATUS,
            CREATED_AT
        ) VALUES (
            #{billId,jdbcType=NUMERIC},
            #{customerId,jdbcType=NUMERIC},
            #{totalCost,jdbcType=NUMERIC},
            #{remainCost,jdbcType=NUMERIC},
            #{status,jdbcType=NUMERIC},
            #{createdAt,jdbcType=TIMESTAMP}
        )
    </insert>

    <!-- 고객별 Bill 목록 조회 -->
    <select id="listBillsByCustomerId" parameterType="long" resultType="com.myproject.caseNara.model.Bill">
        SELECT 
            BILL_ID as billId,
            CUSTOMER_ID as customerId,
            TOTAL_COST as totalCost,
            REMAIN_COST as remainCost,
            STATUS as status,
            CREATED_AT as createdAt
        FROM BILLS
        WHERE CUSTOMER_ID = #{customerId}
        ORDER BY CREATED_AT DESC
    </select>

    <!-- 전체 Bill 목록 조회 (선택적 날짜 필터, 고객명 포함) -->
    <select id="listBills" resultType="map">
        SELECT 
            b.BILL_ID as billId,
            b.CUSTOMER_ID as customerId,
            c.COMPANY_NAME as customerName,
            b.TOTAL_COST as totalCost,
            b.REMAIN_COST as remainCost,
            b.STATUS as status,
            b.CREATED_AT as createdAt
        FROM BILLS b
        JOIN CUSTOMERS c ON b.CUSTOMER_ID = c.CUSTOMER_ID
        WHERE 1=1
        <if test="startDate != null and endDate != null">
          AND DATE(b.CREATED_AT) &gt;= DATE(#{startDate})
          AND DATE(b.CREATED_AT) &lt;= DATE(#{endDate})
        </if>
        ORDER BY b.CREATED_AT DESC
    </select>

    <!-- 남은 금액 업데이트 -->
    <update id="updateRemainCost">
        UPDATE BILLS
        SET REMAIN_COST = #{remainCost}
        WHERE BILL_ID = #{billId}
    </update>

    <!-- 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE BILLS
        SET STATUS = #{status}
        WHERE BILL_ID = #{billId}
    </update>

    <!-- 받은 금액 반영: REMAIN_COST 차감, 상태 동시 업데이트 -->
    <update id="applyReceive">
        UPDATE BILLS
        SET 
            STATUS = CASE WHEN REMAIN_COST - #{amount} &lt;= 0 THEN 2 ELSE 1 END,
            REMAIN_COST = GREATEST(REMAIN_COST - #{amount}, 0)
        WHERE BILL_ID = #{billId}
    </update>

    <!-- 완납 처리: REMAIN_COST=0, STATUS=2 -->
    <update id="settleBill">
        UPDATE BILLS
        SET REMAIN_COST = 0,
            STATUS = 2
        WHERE BILL_ID = #{billId}
    </update>

    <!-- 롤백 처리: REMAIN_COST=TOTAL_COST, STATUS=0 -->
    <update id="rollbackBill">
        UPDATE BILLS
        SET REMAIN_COST = TOTAL_COST,
            STATUS = 0
        WHERE BILL_ID = #{billId}
    </update>

    <!-- bills_sales 매핑 일괄 저장 -->
    <insert id="insertBillSales">
        INSERT INTO BILLS_SALES (BILL_ID, SALES_ID)
        VALUES
        <foreach collection="salesIds" item="sid" separator=",">
            (#{billId}, #{sid})
        </foreach>
    </insert>

    <!-- 상태=0인 Bill과 매핑된 Sales를 조회 -->
    <select id="listBillsWithSales" resultType="com.myproject.caseNara.model.BillWithSales">
        SELECT 
            a.BILL_ID as billId,
            a.CUSTOMER_ID as customerId,
            a.TOTAL_COST as totalCost,
            a.REMAIN_COST as remainCost,
            a.STATUS as status,
            a.CREATED_AT as createdAt,
            b.SALES_ID as salesId
        FROM BILLS a
        JOIN BILLS_SALES b ON a.BILL_ID = b.BILL_ID
        WHERE a.STATUS = 0
        ORDER BY a.BILL_ID
    </select>

    <!-- 특정 BILL_ID의 매핑된 SALES_ID 목록 조회 (상태와 무관) -->
    <select id="listSalesIdsByBillId" parameterType="long" resultType="long">
        SELECT SALES_ID
        FROM BILLS_SALES
        WHERE BILL_ID = #{billId}
        ORDER BY SALES_ID
    </select>

    <select id="findBillIdBySaleId" parameterType="long" resultType="long">
        SELECT BILL_ID
        FROM BILLS_SALES
        WHERE SALES_ID = #{saleId}
    </select>

    <delete id="deleteBillByBillId" parameterType="long">
        DELETE FROM BILLS
        WHERE BILL_ID = #{billId}
    </delete>
    
    <delete id="deleteBillSalesByBillId" parameterType="long">
        DELETE FROM BILLS_SALES
        WHERE BILL_ID = #{billId}
    </delete>
    
</mapper>
