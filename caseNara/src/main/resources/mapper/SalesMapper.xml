<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myproject.caseNara.mapper.SalesMapper">

    <insert id="insertSale" parameterType="com.myproject.caseNara.model.Sale" useGeneratedKeys="true" keyProperty="saleId">
        <selectKey keyProperty="saleId" resultType="long" order="BEFORE">
            SELECT COALESCE(
                (
                    SELECT SALE_ID FROM SALES 
                    WHERE CUSTOMER_ID = #{customerId}
                      AND DATE(SALE_AT) = DATE(#{saleAt})
                      AND IFNULL(DELETED, 0) = 0
                    LIMIT 1
                ),
                (
                    SELECT COALESCE(MAX(SALE_ID), 0) + 1 FROM SALES
                )
            )
        </selectKey>
        INSERT INTO SALES (
            SALE_ID,
            CUSTOMER_ID,
            PRODUCT_ID,
            QUANTITY,
            UNIT_PRICE,
            SALE_AT,
            DELETED
        ) VALUES (
            #{saleId,jdbcType=NUMERIC},
            #{customerId,jdbcType=NUMERIC},
            #{productId,jdbcType=NUMERIC},
            #{quantity,jdbcType=NUMERIC},
            #{unitPrice,jdbcType=NUMERIC},
            #{saleAt,jdbcType=TIMESTAMP},
            0
        )
    </insert>

    <!-- 상호명 기준 인기 상품 Top 5 -->
    <select id="listTopProductNamesByCompanyName" parameterType="string" resultType="string">
        SELECT PRODUCT_NAME
        FROM (
            SELECT p.PRODUCT_NAME AS PRODUCT_NAME, COUNT(1) AS CNT
            FROM SALES s
            JOIN PRODUCTS p ON s.PRODUCT_ID = p.PRODUCT_ID
            JOIN CUSTOMERS c ON s.CUSTOMER_ID = c.CUSTOMER_ID
            WHERE c.COMPANY_NAME = #{companyName}
              AND IFNULL(s.DELETED, 0) = 0
              AND IFNULL(p.DELETED, 0) = 0
              AND IFNULL(c.DELETED, 0) = 0
            GROUP BY p.PRODUCT_NAME
            ORDER BY CNT DESC
        ) t
        LIMIT 5
    </select>

    <!-- 판매 목록 조회 (날짜 기준) -->
    <select id="listSales" resultType="com.myproject.caseNara.model.Sale">
        SELECT 
            s.SALE_ID,
            s.CUSTOMER_ID,
            s.PRODUCT_ID,
            s.QUANTITY,
            s.UNIT_PRICE,
            s.SALE_AT,
            s.CREATED_AT,
            s.UPDATED_AT,
            c.COMPANY_NAME as customerName,
            p.PRODUCT_NAME as productName,
            p.SALE_PRICE as productPrice,
            s.bill_status as billStatus
        FROM SALES s
        JOIN CUSTOMERS c ON s.CUSTOMER_ID = c.CUSTOMER_ID
        JOIN PRODUCTS p ON s.PRODUCT_ID = p.PRODUCT_ID
        WHERE IFNULL(s.DELETED, 0) = 0
          AND IFNULL(c.DELETED, 0) = 0
          AND IFNULL(p.DELETED, 0) = 0
          AND DATE(s.SALE_AT) &gt;= DATE(#{startDate})
          AND DATE(s.SALE_AT) &lt;= DATE(#{endDate})
        ORDER BY s.SALE_AT ASC
    </select>

    <!-- 동일 날짜/고객/상품에 대한 주문 조회 -->
    <select id="findExistingSale" resultType="com.myproject.caseNara.model.Sale">
        SELECT 
            SALE_ID,
            CUSTOMER_ID,
            PRODUCT_ID,
            QUANTITY,
            UNIT_PRICE,
            SALE_AT
        FROM SALES
        WHERE CUSTOMER_ID = #{customerId}
          AND PRODUCT_ID = #{productId}
          AND DATE(SALE_AT) = DATE(#{saleAt})
          AND IFNULL(DELETED, 0) = 0
    </select>

    <!-- 기존 주문 수량 및 금액 업데이트 -->
    <update id="updateSaleQuantity">
        UPDATE SALES
        SET QUANTITY = QUANTITY + #{additionalQuantity},
            UNIT_PRICE = UNIT_PRICE + #{additionalPrice}
        WHERE SALE_ID = #{saleId}
          AND PRODUCT_ID = #{productId}
          AND IFNULL(DELETED, 0) = 0
    </update>

    <!-- 기존 SALE_ID로 신규 항목 추가 -->
    <insert id="insertSaleWithId" parameterType="com.myproject.caseNara.model.Sale">
        INSERT INTO SALES (
            SALE_ID,
            CUSTOMER_ID,
            PRODUCT_ID,
            QUANTITY,
            UNIT_PRICE,
            SALE_AT,
            DELETED
        ) VALUES (
            #{saleId,jdbcType=NUMERIC},
            #{customerId,jdbcType=NUMERIC},
            #{productId,jdbcType=NUMERIC},
            #{quantity,jdbcType=NUMERIC},
            #{unitPrice,jdbcType=NUMERIC},
            #{saleAt,jdbcType=TIMESTAMP},
            0
        )
    </insert>

    <!-- 특정 상품을 주문에서 삭제(소프트 삭제) -->
    <update id="deleteSaleItem">
        UPDATE SALES
        SET DELETED = 1
        WHERE SALE_ID = #{saleId}
          AND PRODUCT_ID = #{productId}
          AND IFNULL(DELETED, 0) = 0
    </update>

    <!-- 활성 레코드 합계 집계 (MYSQL 호환) -->
    <select id="sumActiveSaleProduct" resultType="map">
        SELECT 
            COALESCE(SUM(QUANTITY), 0) AS totalQty,
            COALESCE(SUM(UNIT_PRICE), 0) AS totalPrice
        FROM SALES
        WHERE SALE_ID = #{saleId}
          AND PRODUCT_ID = #{productId}
          AND IFNULL(DELETED, 0) = 0
    </select>

    <!-- 대표 행에 집계 반영 (단일 테이블 UPDATE + ORDER BY/LIMIT 허용) -->
    <update id="updateCanonicalRowWithAggregates">
        UPDATE SALES
        SET QUANTITY = #{totalQty},
            UNIT_PRICE = #{totalPrice}
        WHERE SALE_ID = #{saleId}
          AND PRODUCT_ID = #{productId}
          AND IFNULL(DELETED, 0) = 0
        ORDER BY SALE_AT
        LIMIT 1
    </update>

    <!-- 중복 활성 레코드 제거: 대표 행 제외하고 하드 삭제 -->
    <delete id="deleteOtherActiveDuplicates">
        DELETE FROM SALES
        WHERE SALE_ID = #{saleId}
          AND PRODUCT_ID = #{productId}
          AND IFNULL(DELETED, 0) = 0
          AND NOT EXISTS (
            SELECT 1 FROM (
              SELECT SALE_ID, PRODUCT_ID, SALE_AT
              FROM SALES
              WHERE SALE_ID = #{saleId}
                AND PRODUCT_ID = #{productId}
                AND IFNULL(DELETED, 0) = 0
              ORDER BY SALE_AT
              LIMIT 1
            ) keep
            WHERE keep.SALE_ID = SALES.SALE_ID
              AND keep.PRODUCT_ID = SALES.PRODUCT_ID
              AND keep.SALE_AT = SALES.SALE_AT
          )
    </delete>

    <!-- 삭제된 레코드 모두 제거: 유니크 충돌 방지용 하드 삭제 -->
    <delete id="deleteAllDeletedRowsForSaleProduct">
        DELETE FROM SALES
        WHERE SALE_ID = #{saleId}
          AND PRODUCT_ID = #{productId}
          AND IFNULL(DELETED, 0) = 1
    </delete>

    <!-- 동일 SALE_ID의 모든 항목 주문일자 업데이트 -->
    <update id="updateSaleDateBySaleId">
        UPDATE SALES
        SET SALE_AT = #{saleAt,jdbcType=TIMESTAMP}
        WHERE SALE_ID = #{saleId}
    </update>

    <!-- 판매 ID로 판매 조회 -->
    <select id="findSalesById" resultType="com.myproject.caseNara.model.Sale">
        SELECT 
            s.SALE_ID,
            s.CUSTOMER_ID,
            s.PRODUCT_ID,
            s.QUANTITY,
            s.UNIT_PRICE,
            s.SALE_AT,
            s.CREATED_AT,
            s.UPDATED_AT,
            c.COMPANY_NAME as customerName,
            p.PRODUCT_NAME as productName,
            p.SALE_PRICE as productPrice
        FROM SALES s
        JOIN CUSTOMERS c ON s.CUSTOMER_ID = c.CUSTOMER_ID
        JOIN PRODUCTS p ON s.PRODUCT_ID = p.PRODUCT_ID
        WHERE s.SALE_ID = #{saleId}
          AND IFNULL(s.DELETED, 0) = 0
          AND IFNULL(c.DELETED, 0) = 0
          AND IFNULL(p.DELETED, 0) = 0
    </select>

    <!-- 선택한 SALE_ID들의 청구 상태(bill_status)를 1로 업데이트 -->
    <update id="updateBillSatatus">
        UPDATE SALES
        SET BILL_STATUS = 1
        WHERE IFNULL(DELETED, 0) = 0
          AND SALE_ID = #{salesId}
    </update>

    <!-- SALE_ID 목록에 대해 청구 상태(bill_status)를 0으로 초기화 -->
    <update id="resetBillStatusBySaleIds">
        UPDATE SALES
        SET BILL_STATUS = 0
        WHERE IFNULL(DELETED, 0) = 0
          AND SALE_ID IN
          <foreach collection="salesIds" item="sid" open="(" separator="," close=")">
            #{sid}
          </foreach>
    </update>
</mapper>
